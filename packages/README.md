# Managing Packages

[Inspired by WordPress Gutenberg](https://github.com/WordPress/gutenberg/tree/trunk/packages)

This repository uses [npm workspaces](https://docs.npmjs.com/cli/v10/using-npm/workspaces) to manage WordPress packages and [lerna](https://lerna.js.org/) to publish them with to [npm](https://www.npmjs.com/).

## Commit Messages

Ensure your commit messages follow the [conventional commits](https://gist.github.com/qoomon/5dfcdf8eec66a051ecd85625518cfd13) format.

## Creating a New Package

When creating a new package, you need to provide at least the following:-

1. `package.json` based on the template:

    ```jsonc
    {
    	"name": "@hizzlewp/package-name",
    	"version": "1.0.0-prerelease",
    	"description": "Package description.",
    	"author": "The WordPress Contributors",
    	"license": "GPL-2.0-or-later",
    	"keywords": [ "wordpress", "hizzle" ],
    	"homepage": "https://github.com/hizzle-co/hizzle/tree/HEAD/packages/package-name/README.md",
    	"repository": {
    		"type": "git",
    		"url": "https://github.com/hizzle-co/hizzle.git",
    		"directory": "packages/package-name"
    	},
    	"bugs": {
    		"url": "https://github.com/hizzle-co/hizzle/issues"
    	},
    	"engines": {
    		"node": ">=18.12.0",
    		"npm": ">=8.19.2"
    	},
    	"main": "build-module/index.js",
    	"module": "build-module/index.esm.js",
    	"types": "build-types/index.d.ts",
    	"files": [
    		"build-module",
    		"build-types"
    	],
    	"publishConfig": {
    		"access": "public"
    	}
    }
    ```

    This assumes that your code is located in the `src` folder and will be transpiled with `Babel`. The `src` folder should contain a `index.ts` | `index.js` | `index.tsx` | `index.jsx` file that exports the default component.

2. `README.md` file containing at least:
    - Package name
    - Package description
    - Installation details
    - Usage example

To ensure your package is recognized in npm workspaces, you should run `npm install` to update the package lock file.

## Managing Dependencies

There are two types of dependencies that you might want to add to one of the existing packages.

### Production Dependencies

Production dependencies are stored in the `dependencies` section of the packageâ€™s `package.json` file.

#### Adding New Dependencies

The simplest way to add a production dependency to one of the packages is to run a command like the following from the root of the project.

_Example:_

```bash
npm install change-case -w packages/components
```

This command adds the `change-case` as a dependency to the `@hizzlewp/components` package, which is located in `packages/components` folder. If there was the same dependency installed then the version specified in the `package-lock.json` file is going to be reused. If you want to enforce a different version, you can do so by adding the `@` suffix to the package name.

_Example:_

```bash
npm install change-case@latest -w packages/components
```

#### Removing Existing Dependencies

Removing a dependency from one of the WordPress packages is similar to installation. You need to run a command like the following from the root of the project.

_Example:_

```bash
npm uninstall change-case -w packages/components
```

#### Updating Existing Dependencies

This is the most confusing part of working with [monorepos](https://en.wikipedia.org/wiki/Monorepo) which causes a lot of hassles for contributors. The most successful strategy so far is to do the following:

1.  First, remove the existing dependency as described in the previous section.
2.  Next, add the same dependency back as described in the first section of this chapter. This time it will get the latest version applied unless you enforce a different version explicitly.

### Development Dependencies

In contrast to production dependencies, development dependencies shouldn't be stored in individual WordPress packages. Instead they should be installed in the project's `package.json` file using the usual `npm install` command. In effect, all development tools are configured to work with every package at the same time to ensure they share the same characteristics and integrate correctly with each other.

_Example:_

```bash
npm install glob --save-dev
```

This commands adds the latest version of `glob` as a development dependency to the `package.json` file. It has to be executed from the root of the project.

## Maintaining API documentation

Each public API change needs to be reflected in the corresponding API documentation. To ensure that code and documentation are in sync automatically, Gutenberg has developed a few utilities.

Packages can add the following HTML comment within their top-level `README.md`:

```markdown
<!-- START TOKEN(Autogenerated API docs) -->

Content within the HTML comment will be replaced by the generated documentation.

<!-- END TOKEN(Autogenerated API docs) -->`.
```

Each time there is a commit to the public API of the package the `README.md` will be updated and kept in sync.

The above snippet within the package's `README.md` signals the Gutenberg utilities to go to `src/index.js` and extract the JSDoc comments of the export statements into a more friendly format.

Packages may want to use a different source file or add the exports of many files into the same `README.md` (see `packages/core-data/README.md` as an example); they can do so by adding the relative path to be used as source into the HTML comment:

```markdown
<!-- START TOKEN(Autogenerated API docs|src/actions.js) -->

Content within the HTML comment will be replaced by the generated documentation.

<!-- END TOKEN(Autogenerated API docs|src/actions.js) -->`.
```

## Maintaining a Public API

It's very important to have a good plan for what a new package will include. All constants, methods, and components exposed from the package will ultimately become part of the public API in WordPress (exposed via the `hizzlewp` global - eg: `hizzlewp.components`) and as such will need to be supported indefinitely.

## Using TypeScript

To opt-in to TypeScript tooling, packages should include a `tsconfig.json` file in the package root and add an entry to the root `tsconfig.json` references.
The changes will indicate that the package has opted in and will be included in the TypeScript build process.

A `tsconfig.json` file should look like the following (comments are not necessary):

```jsonc
{
	// Extends a base configuration common to most packages
	"extends": "../../tsconfig.base.json",

	// Options for the TypeScript compiler
	// We'll usually set our `rootDir` and `declarationDir` as follows, which is specific
	// to each project.
	"compilerOptions": {
		"rootDir": "src",
		"declarationDir": "build-types"
	},

	// Which source files should be included
	"include": [ "src/**/*" ],

	// Other HizzleWP package dependencies that have opted-in to TypeScript should be listed
	// here. In this case, our package depends on `@hizzlewp/components`.
	"references": [ { "path": "../components" } ]
}
```

Type declarations will be produced in the `build-types` which should be included in the published package.
For consumers to use the published type declarations, we'll set the `types` field in `package.json`:

```json
{
	"main": "build-module/index.js",
	"module": "build-module/index.esm.js",
	"types": "build-types/index.d.ts",
	"files": [
		"build-module",
		"build-types"
	]
}
```

Ensure that the `build-types` directory will be included in the published package, for example if a `files` field is declared.

## Optimizing for bundlers

In order for bundlers to tree-shake packages effectively, they often need to know whether a package includes side effects in its code. This is done through the `sideEffects` field in the package's `package.json`.

IMPORTANT: CSS files won't be extracted if the `sideEffects` field is set to `false`.

If your package has no side effects, simply set the field to `false`:

```json
{
	"name": "package",
	"sideEffects": false
}
```

If your package includes a few files with side effects, you can list them instead:

```json
{
	"name": "package",
	"sideEffects": [
		"file-with-side-effects.js",
		"another-file-with-side-effects.js"
	]
}
```

Please consult the [side effects documentation](https://github.com/WordPress/gutenberg/blob/HEAD/packages/side-effects.md) for more information on identifying and declaring side effects.
